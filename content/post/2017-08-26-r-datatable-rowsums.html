---
title: Rdatatable中按行求和
author: 波
date: '2017-08-26'
slug: Rdatatable中按行求和
categories: []
tags: []
---



<p>在实际工作中会遇到按行求和的情况，如下表所示，知道了门诊人次，急诊人次，想在最右边加一列门急诊合计人次。</p>
<pre class="r"><code>library(data.table)
menJiZhen &lt;- data.table(keShi = c(&#39;内科&#39;, &#39;外科&#39;, &#39;骨科&#39;, &#39;妇产科&#39;, &#39;儿科&#39;, &#39;皮肤科&#39;),
                        menZhenRenCi = c(555, 666, 777, 888 ,999, 111),
                        jiZhenRenCi = c(55, 66, 77, 88, 99, NA))
knitr::kable(menJiZhen)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">keShi</th>
<th align="right">menZhenRenCi</th>
<th align="right">jiZhenRenCi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">内科</td>
<td align="right">555</td>
<td align="right">55</td>
</tr>
<tr class="even">
<td align="left">外科</td>
<td align="right">666</td>
<td align="right">66</td>
</tr>
<tr class="odd">
<td align="left">骨科</td>
<td align="right">777</td>
<td align="right">77</td>
</tr>
<tr class="even">
<td align="left">妇产科</td>
<td align="right">888</td>
<td align="right">88</td>
</tr>
<tr class="odd">
<td align="left">儿科</td>
<td align="right">999</td>
<td align="right">99</td>
</tr>
<tr class="even">
<td align="left">皮肤科</td>
<td align="right">111</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div id="rowsums" class="section level2">
<h2>采用<code>rowSums</code>函数</h2>
<pre class="r"><code>methods01 &lt;- copy(menJiZhen)
methods01[, heJi := rowSums(.SD, na.rm = TRUE), .SDcols = c(&#39;menZhenRenCi&#39;, &#39;jiZhenRenCi&#39;)]
knitr::kable(methods01)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">keShi</th>
<th align="right">menZhenRenCi</th>
<th align="right">jiZhenRenCi</th>
<th align="right">heJi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">内科</td>
<td align="right">555</td>
<td align="right">55</td>
<td align="right">610</td>
</tr>
<tr class="even">
<td align="left">外科</td>
<td align="right">666</td>
<td align="right">66</td>
<td align="right">732</td>
</tr>
<tr class="odd">
<td align="left">骨科</td>
<td align="right">777</td>
<td align="right">77</td>
<td align="right">854</td>
</tr>
<tr class="even">
<td align="left">妇产科</td>
<td align="right">888</td>
<td align="right">88</td>
<td align="right">976</td>
</tr>
<tr class="odd">
<td align="left">儿科</td>
<td align="right">999</td>
<td align="right">99</td>
<td align="right">1098</td>
</tr>
<tr class="even">
<td align="left">皮肤科</td>
<td align="right">111</td>
<td align="right">NA</td>
<td align="right">111</td>
</tr>
<tr class="odd">
<td align="left">如果要计算</td>
<td align="right">的列中包含空值，</td>
<td align="right">可以通过设置 `</td>
<td align="right">rowSums<code>函数的</code>na.rm = TRUE<code>参数来排除空值。示例中，皮肤科没有急诊，默认情况下（</code>na.rm = FALSE<code>），计算结果是</code>NA`，不是希望的结果。</td>
</tr>
</tbody>
</table>
</div>
<div id="reduce--" class="section level2">
<h2>采用 <code>Reduce</code> 和 <code>+</code> 函数</h2>
<pre class="r"><code>methods02 &lt;- copy(menJiZhen)
sumCols &lt;- c(&#39;menZhenRenCi&#39;, &#39;jiZhenRenCi&#39;)
for(col in sumCols) set(methods02, i = which(is.na(methods02[[col]])), j = col, 0L)
methods02[, heJi := Reduce(`+`, .SD), .SDcols = sumCols]
knitr::kable(methods02)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">keShi</th>
<th align="right">menZhenRenCi</th>
<th align="right">jiZhenRenCi</th>
<th align="right">heJi</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">内科</td>
<td align="right">555</td>
<td align="right">55</td>
<td align="right">610</td>
</tr>
<tr class="even">
<td align="left">外科</td>
<td align="right">666</td>
<td align="right">66</td>
<td align="right">732</td>
</tr>
<tr class="odd">
<td align="left">骨科</td>
<td align="right">777</td>
<td align="right">77</td>
<td align="right">854</td>
</tr>
<tr class="even">
<td align="left">妇产科</td>
<td align="right">888</td>
<td align="right">88</td>
<td align="right">976</td>
</tr>
<tr class="odd">
<td align="left">儿科</td>
<td align="right">999</td>
<td align="right">99</td>
<td align="right">1098</td>
</tr>
<tr class="even">
<td align="left">皮肤科</td>
<td align="right">111</td>
<td align="right">0</td>
<td align="right">111</td>
</tr>
<tr class="odd">
<td align="left">这种方法里</td>
<td align="right">，也是首先把空值</td>
<td align="right">替换成 0 ， 再</td>
<td align="right">用 <code>Reduce</code> 和 <code>+</code> 函数来求和。</td>
</tr>
</tbody>
</table>
<p>两种方法里，第一种得到的合计列，是 <code>double</code> 类型的，而第二种方法里是 <code>integer</code> 类型的。</p>
<p>参考：<a href="https://stackoverflow.com/questions/45960913/sum-of-integer-columns-is-double/45961107#45961107">Sum of integer columns is double</a></p>
</div>
